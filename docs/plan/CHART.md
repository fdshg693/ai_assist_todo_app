# アーキテクチャ図・構造図集

このドキュメントは、AI Assist Todo Appのアーキテクチャと構造を図で説明します。
技術的な詳細（ライブラリ、バージョン等）は [PLAN.md](PLAN.md) を参照してください。

## 目次

1. [C4コンテキスト図](#1-c4コンテキスト図)
2. [C4コンテナ構成図](#2-c4コンテナ構成図)
3. [通信フロー図](#3-通信フロー図)
4. [レイヤードアーキテクチャ図](#4-レイヤードアーキテクチャ図)
5. [Docker Compose構成図](#5-docker-compose構成図)

---

## 1. C4コンテキスト図

システム全体とユーザー・外部システムの関係を示します。

```
                                    ┌─────────────────────┐
                                    │                     │
                                    │   エンドユーザー      │
                                    │                     │
                                    │  (Todo管理を行う     │
                                    │   アプリ利用者)      │
                                    │                     │
                                    └──────────┬──────────┘
                                               │
                                               │ Todoの管理
                                               │ AIアシスト機能の利用
                                               │
                                    ┌──────────▼──────────┐
                                    │                     │
                                    │  AI Assist Todo App │
                                    │                     │
                                    │  AIアシスト機能を   │
                                    │  持つTodo管理       │
                                    │  アプリケーション    │
                                    │                     │
                                    └──────────┬──────────┘
                                               │
                                               │ AIモデル呼び出し
                                               │ (レコメンド・サマリ生成)
                                               │
                                    ┌──────────▼──────────┐
                                    │                     │
                                    │ Azure OpenAI Service│
                                    │                     │
                                    │  GPT-5-nano等の     │
                                    │  AIモデルを提供     │
                                    │                     │
                                    └─────────────────────┘
```

### 説明
- **エンドユーザー**: アプリケーションを利用してTodo管理を行う
- **AI Assist Todo App**: Todo管理とAI支援機能を提供するシステム
- **Azure OpenAI Service**: AI推論を提供する外部サービス

---

## 2. C4コンテナ構成図

Frontend、Backend、Database、Azure OpenAI Serviceの関係を示します。

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│                          エンドユーザー                              │
│                                                                     │
└───────────┬─────────────────────────────────────────────────────────┘
            │                                             
            │ HTTPS                                       
            │ (Webブラウザ)                               
            │                                             
┌───────────▼──────────────┐                 ┌────────────────────────┐
│                          │                 │                        │
│   Frontend Container     │                 │   Backend Container    │
│                          │                 │                        │
│  ┌────────────────────┐  │   REST API      │  ┌──────────────────┐  │
│  │  React App         │  │   (HTTPS/JSON)  │  │  ASP.NET Core    │  │
│  │  TypeScript        │◄─┼─────────────────┼─►│  Web API         │  │
│  │                    │  │                 │  │  C# + Dapper     │  │
│  │  - UI Components   │  │                 │  │                  │  │
│  │  - State Mgmt      │  │                 │  │  - Controllers   │  │
│  │  - API Client      │  │                 │  │  - Services      │  │
│  └────────────────────┘  │                 │  │  - Domain Logic  │  │
│                          │                 │  └──────────────────┘  │
│  Port: 3000              │                 │                        │
└──────────────────────────┘                 └────────┬───────────────┘
                                                      │
                                                      │ Port: 5000
                     ┌────────────────────────────────┼────────────────┐
                     │                                │                │
                     │ SQL/TCP                        │ HTTPS          │
                     │                                │                │
          ┌──────────▼───────────┐         ┌──────────▼─────────┐     │
          │                      │         │                    │     │
          │  Database Container  │         │  Azure OpenAI      │     │
          │                      │         │  Service           │     │
          │  ┌────────────────┐  │         │                    │     │
          │  │  PostgreSQL    │  │         │  - gpt-5-nano     │     │
          │  │                │  │         │  - Response API   │     │
          │  │  - Todos Table │  │         │                    │     │
          │  │  - Users Table │  │         └────────────────────┘     │
          │  └────────────────┘  │                                    │
          │                      │         (External Service)         │
          │  Port: 5432          │                                    │
          └──────────────────────┘                                    │
                                                                      │
          (Docker Container)                                          │
                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### コンテナ詳細

#### Frontend Container
- **技術**: React 18+, TypeScript 5+
- **責務**: ユーザーインターフェース
- **ポート**: 3000
- **主要機能**: Todo管理UI、AIレコメンド表示、AIサマリ表示

#### Backend Container
- **技術**: .NET 10, ASP.NET Core Web API
- **責務**: ビジネスロジックとAPIエンドポイント
- **ポート**: 5000
- **主要機能**: Todo CRUD API、AI統合サービス、認証・認可

#### Database Container
- **技術**: PostgreSQL
- **責務**: データ永続化
- **ポート**: 5432
- **主要テーブル**: Todos、Users

#### Azure OpenAI Service (External)
- **技術**: Azure OpenAI
- **責務**: AI推論とテキスト生成
- **使用モデル**: gpt-5-nano (デフォルト)
- **用途**: タスクレコメンド、サマリ生成

---

## 3. 通信フロー図

### Todo作成フロー

```
┌─────────┐         ┌──────────┐         ┌──────────┐         ┌──────────┐
│  User   │         │ Frontend │         │ Backend  │         │ Database │
└────┬────┘         └────┬─────┘         └────┬─────┘         └────┬─────┘
     │                   │                    │                    │
     │ 1. Todo入力       │                    │                    │
     │──────────────────►│                    │                    │
     │                   │                    │                    │
     │                   │ 2. POST /api/todos │                    │
     │                   │───────────────────►│                    │
     │                   │                    │                    │
     │                   │                    │ 3. INSERT Todo     │
     │                   │                    │───────────────────►│
     │                   │                    │                    │
     │                   │                    │ 4. Success         │
     │                   │                    │◄───────────────────│
     │                   │                    │                    │
     │                   │ 5. 201 Created     │                    │
     │                   │◄───────────────────│                    │
     │                   │                    │                    │
     │ 6. UI更新         │                    │                    │
     │◄──────────────────│                    │                    │
     │                   │                    │                    │
```

### AIレコメンドフロー

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────────┐
│  User   │    │ Frontend │    │ Backend  │    │ Database │    │ Azure OpenAI │
└────┬────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └──────┬───────┘
     │              │               │               │                 │
     │ 1. レコメンド要求 │               │               │                 │
     │─────────────►│               │               │                 │
     │              │               │               │                 │
     │              │ 2. GET /api/todos/recommend   │                 │
     │              │──────────────►│               │                 │
     │              │               │               │                 │
     │              │               │ 3. SELECT Todos                 │
     │              │               │──────────────►│                 │
     │              │               │               │                 │
     │              │               │ 4. Todos      │                 │
     │              │               │◄──────────────│                 │
     │              │               │               │                 │
     │              │               │ 5. AI推論リクエスト              │
     │              │               │─────────────────────────────────►│
     │              │               │               │                 │
     │              │               │ 6. レコメンド結果                │
     │              │               │◄─────────────────────────────────│
     │              │               │               │                 │
     │              │ 7. 200 OK     │               │                 │
     │              │◄──────────────│               │                 │
     │              │               │               │                 │
     │ 8. レコメンド表示 │               │               │                 │
     │◄─────────────│               │               │                 │
     │              │               │               │                 │
```

---

## 4. レイヤードアーキテクチャ図

バックエンドの層構造を示します。

```
┌─────────────────────────────────────────────────────────┐
│                  Presentation Layer                     │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │           Controllers (API Endpoints)            │   │
│  │  - TodosController                               │   │
│  │  - RecommendController                           │   │
│  │  - SummaryController                             │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                  Application Layer                      │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │              Services (Business Logic)           │   │
│  │  - TodoService                                   │   │
│  │  - AIRecommendationService                       │   │
│  │  - AISummaryService                              │   │
│  │  - Microsoft Agent Framework Integration         │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                    Domain Layer                         │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │          Models & Interfaces                     │   │
│  │  - Todo (Entity)                                 │   │
│  │  - User (Entity)                                 │   │
│  │  - ITodoRepository                               │   │
│  │  - IAIService                                    │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                Infrastructure Layer                     │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │   Database & External APIs Implementation        │   │
│  │  - PostgreSQL (via Dapper)                       │   │
│  │  - Azure OpenAI Service Client                   │   │
│  │  - TodoRepository                                │   │
│  │  - AIServiceClient                               │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### レイヤーの責務

1. **Presentation Layer**: HTTP リクエスト/レスポンスの処理
2. **Application Layer**: ビジネスロジックの実装
3. **Domain Layer**: ドメインモデルとインターフェース定義
4. **Infrastructure Layer**: データベースと外部API連携

---

## 5. Docker Compose構成図

開発環境のDockerコンテナ構成を示します。

```
┌───────────────────────────────────────────────────────────────┐
│                      Docker Compose                           │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                     Network: app-network                │  │
│  │                                                         │  │
│  │  ┌──────────────────┐  ┌──────────────────┐            │  │
│  │  │   frontend       │  │     backend      │            │  │
│  │  │                  │  │                  │            │  │
│  │  │  - React App     │  │  - .NET 10 API   │            │  │
│  │  │  - Node.js       │  │  - Dapper        │            │  │
│  │  │  - Vite Dev      │  │  - Serilog       │            │  │
│  │  │                  │  │                  │            │  │
│  │  │  Port: 3000      │  │  Port: 5000      │            │  │
│  │  │  ↓               │  │  ↓               │            │  │
│  │  │  → Host:3000     │  │  → Host:5000     │            │  │
│  │  └──────────────────┘  └──────────┬───────┘            │  │
│  │                                   │                    │  │
│  │                                   │ SQL/TCP            │  │
│  │                                   ↓                    │  │
│  │                        ┌──────────────────┐            │  │
│  │                        │    database      │            │  │
│  │                        │                  │            │  │
│  │                        │  - PostgreSQL    │            │  │
│  │                        │  - Persistent    │            │  │
│  │                        │    Volume        │            │  │
│  │                        │                  │            │  │
│  │                        │  Port: 5432      │            │  │
│  │                        │  ↓               │            │  │
│  │                        │  → Host:5432     │            │  │
│  │                        └──────────────────┘            │  │
│  │                                                         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                               │
│  Volumes:                                                     │
│  - postgres-data (永続化)                                      │
│                                                               │
└───────────────────────────────────────────────────────────────┘

外部サービス (Azure OpenAI) への接続
           ↑
           │ HTTPS
           │
    ┌──────┴──────┐
    │   backend   │
    └─────────────┘
```

### サービス構成

```yaml
services:
  frontend:
    - React開発サーバー (Vite)
    - ポート: 3000 → 3000
    - ネットワーク: app-network
    
  backend:
    - .NET 10 Web API
    - ポート: 5000 → 5000
    - 環境変数: 
      - DATABASE_URL
      - AZURE_OPENAI_ENDPOINT
      - AZURE_OPENAI_API_KEY
    - ネットワーク: app-network
    
  database:
    - PostgreSQL
    - ポート: 5432 → 5432
    - ボリューム: postgres-data
    - ネットワーク: app-network
```

### 特徴

- **開発環境に特化**: ホットリロード、デバッグ機能
- **ネットワーク分離**: app-networkで内部通信を管理
- **データ永続化**: postgres-dataボリュームでデータ保持
- **ポートマッピング**: ホストマシンから各サービスにアクセス可能

---

## まとめ

このドキュメントでは、AI Assist Todo Appの主要なアーキテクチャと構造を図で示しました。

- **C4図**: システム全体の構造を段階的に理解
- **通信フロー**: 実際の処理の流れを可視化
- **レイヤードアーキテクチャ**: バックエンドの構造を明確化
- **Docker Compose**: 開発環境の構成

技術的な詳細やライブラリの具体的なバージョンについては、[PLAN.md](PLAN.md) を参照してください。
